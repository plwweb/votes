<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบโหวตเสื้อกีฬาสี</title>
    <link rel="stylesheet" href="style.css"> <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
</head>
<body>
    <div class="container">
        <header>
            <img src="logo.png" alt="โลโก้โรงเรียน" class="logo"> <h1>ระบบโหวตเสื้อกีฬาสี</h1>
            <p id="voting-status" class="message"></p> </header>

        <div class="section" id="vote-section">
            <h2>ลงทะเบียนโหวต</h2>
            <form id="vote-form">
                <label for="studentId">รหัสประจำตัวนักเรียน:</label>
                <input type="text" id="studentId" placeholder="ตัวอย่าง: 12345" required>
                <label for="fullName">ชื่อ-นามสกุล:</label>
                <input type="text" id="fullName" placeholder="ตัวอย่าง: สมชาย ใจดี" required>
                <label for="studentClass">ชั้น:</label>
                <input type="text" id="studentClass" placeholder="ตัวอย่าง: ม.1" required>
                <label for="room">ห้อง:</label>
                <input type="text" id="room" placeholder="ตัวอย่าง: 1" required>

                <h3>เลือกแบบเสื้อที่ต้องการโหวต:</h3>
                <div id="design-selection" class="design-grid">
                    <p>กำลังโหลดแบบเสื้อ...</p>
                </div>
                <button type="submit" id="submitVoteButton">บันทึกการโหวต</button>
                <p id="vote-message" class="message"></p> </form>
        </div>

        <div id="vote-results-container" class="section">
            <h3>ผลสรุปการโหวตล่าสุด</h3>
            <p>จำนวนผู้โหวตทั้งหมด: <span id="total-voters">0</span> คน</p>
            <div id="design-charts" style="width: 100%; max-width: 600px; margin: 20px auto;">
                <canvas id="designVotesChart"></canvas> </div>
            <div id="summary-cards" style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-top: 20px;">
                </div>
        </div>

        <div class="banner-carousel-container">
            <div class="banner-carousel" id="bannerCarousel">
                <p style="text-align: center; color: #666;">กำลังโหลด Banner...</p>
            </div>
            <div class="carousel-indicators" id="carouselIndicators">
                </div>
        </div>

        <footer>
            <p>&copy; 2024 ระบบโหวตเสื้อกีฬาสี. All rights reserved.</p>
        </footer>
    </div>

    <script>
        // Utility function สำหรับเรียกใช้ Google Apps Script Web App
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwHPJQbvafH9SDC5KEIi7xDX0Rz89-aDk87KvlpcERaQp5xsElIBdmIF8UI7-TSEbZF/exec'; // *** เปลี่ยนเป็น URL ของ Web App ที่คุณ Deploy (จากขั้นตอนที่ 6) ***

        async function callApi(action, data = {}) {
            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain', // Apps Script ต้องการ Content-Type เป็น text/plain
                    },
                    body: JSON.stringify({ action, ...data }), // แปลงข้อมูลเป็น JSON string
                });
                return await response.json(); // แปลง response กลับเป็น JSON object
            } catch (error) {
                console.error('API call failed:', error);
                return { status: 'error', message: 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้: ' + error.message };
            }
        }

        // --- Voting Logic (ส่วนการโหวต) ---
        const voteForm = document.getElementById('vote-form');
        const studentIdInput = document.getElementById('studentId');
        const fullNameInput = document.getElementById('fullName');
        const studentClassInput = document.getElementById('studentClass');
        const roomInput = document.getElementById('room');
        const designSelection = document.getElementById('design-selection');
        const submitVoteButton = document.getElementById('submitVoteButton');
        const voteMessage = document.getElementById('vote-message');
        const votingStatus = document.getElementById('voting-status');

        let selectedDesignId = null; // เก็บ Design ID ที่ผู้ใช้เลือก
        let chartInstance = null; // เก็บ instance ของ Chart.js เพื่อให้สามารถทำลายและสร้างใหม่ได้

        // ฟังก์ชันสำหรับโหลดและแสดงแบบเสื้อในส่วนเลือกโหวต
        async function loadDesignsAndDisplay() {
            const result = await callApi('getVoteCount'); // ใช้ getVoteCount เพราะมี Design Name และ Image URL
            designSelection.innerHTML = ''; // ล้างแบบเสื้อเก่าออกก่อน

            if (result.status === 'success' && result.voteCounts && result.voteCounts.length > 0) {
                result.voteCounts.forEach(design => {
                    const designItem = document.createElement('div');
                    designItem.className = 'design-item';
                    designItem.dataset.designId = design.designId; // เก็บ Design ID ไว้ใน dataset
                    designItem.innerHTML = `
                        <img src="${design.imageUrl || 'placeholder.png'}" alt="${design.designName}"> <p>${design.designName}</p>
                    `;
                    designItem.addEventListener('click', () => {
                        // ลบคลาส 'selected' ออกจากแบบเสื้อที่เคยถูกเลือก
                        const currentSelected = designSelection.querySelector('.design-item.selected');
                        if (currentSelected) {
                            currentSelected.classList.remove('selected');
                        }
                        // เพิ่มคลาส 'selected' ให้กับแบบเสื้อที่เพิ่งคลิก
                        designItem.classList.add('selected');
                        selectedDesignId = design.designId; // อัปเดต Design ID ที่เลือก
                    });
                    designSelection.appendChild(designItem);
                });
            } else {
                designSelection.innerHTML = '<p>ยังไม่มีแบบเสื้อให้โหวต โปรดติดต่อผู้ดูแล</p>';
            }
            loadVoteCountAndDisplay(); // โหลดคะแนนโหวตและแสดงผลหลังจากโหลดแบบเสื้อ
        }


        // ฟังก์ชันสำหรับส่งข้อมูลการโหวตเมื่อกดปุ่ม Submit
        voteForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // ป้องกันการ reload หน้าเว็บ

            if (!selectedDesignId) {
                voteMessage.textContent = 'กรุณาเลือกแบบเสื้อที่ต้องการโหวต';
                voteMessage.className = 'message error';
                return;
            }

            submitVoteButton.disabled = true; // ปิดปุ่มเพื่อป้องกันการกดซ้ำ
            voteMessage.textContent = 'กำลังบันทึกการโหวต...';
            voteMessage.className = 'message loading';

            const studentId = studentIdInput.value.trim();
            const fullName = fullNameInput.value.trim();
            const studentClass = studentClassInput.value.trim();
            const room = roomInput.value.trim();

            const result = await callApi('addVote', {
                studentId,
                fullName,
                studentClass,
                room,
                designId: selectedDesignId
            });

            if (result.status === 'success') {
                voteMessage.textContent = result.message;
                voteMessage.className = 'message success';
                // ล้างฟอร์มและรีเซ็ตสถานะหลังโหวตสำเร็จ
                voteForm.reset();
                selectedDesignId = null;
                const currentSelected = designSelection.querySelector('.design-item.selected');
                if (currentSelected) {
                    currentSelected.classList.remove('selected');
                }
                loadVoteCountAndDisplay(); // รีเฟรชคะแนนโหวต
                loadUniqueUsersCount(); // รีเฟรชจำนวนผู้โหวตไม่ซ้ำ
            } else if (result.status === 'voted') {
                voteMessage.textContent = result.message;
                voteMessage.className = 'message info'; // แสดงข้อความว่าเคยโหวตแล้ว
            } else if (result.status === 'closed') {
                voteMessage.textContent = result.message;
                voteMessage.className = 'message error';
            }
            else {
                voteMessage.textContent = result.message;
                voteMessage.className = 'message error';
            }
            submitVoteButton.disabled = false; // เปิดปุ่มอีกครั้ง
        });


        // ฟังก์ชันสำหรับโหลดและแสดงผลสรุปการโหวต (กราฟและสรุปการ์ด)
        async function loadVoteCountAndDisplay() {
            const result = await callApi('getVoteCount');
            if (result.status === 'success') {
                const voteCounts = result.voteCounts;
                const totalVotes = result.totalVotes;
                document.getElementById('total-voters').textContent = totalVotes; // แสดงจำนวนผู้โหวตทั้งหมด

                // เตรียมข้อมูลสำหรับ Chart.js
                const labels = voteCounts.map(d => d.designName);
                const data = voteCounts.map(d => d.count);
                const backgroundColors = [ // สีสำหรับกราฟวงกลม
                    'rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)',
                    'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)',
                    'rgba(199, 199, 199, 0.7)', 'rgba(83, 102, 255, 0.7)'
                ];
                const borderColors = [ // สีขอบสำหรับกราฟวงกลม
                    'rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)',
                    'rgba(199, 199, 199, 1)', 'rgba(83, 102, 255, 1)'
                ];

                const ctx = document.getElementById('designVotesChart').getContext('2d');

                if (chartInstance) {
                    chartInstance.destroy(); // ทำลายกราฟเก่าก่อนสร้างใหม่ (ป้องกันการแสดงผลซ้ำซ้อน)
                }

                chartInstance = new Chart(ctx, {
                    type: 'pie', // ชนิดกราฟวงกลม
                    data: {
                        labels: labels, // ชื่อแบบเสื้อ
                        datasets: [{
                            data: data, // คะแนนโหวต
                            backgroundColor: backgroundColors.slice(0, labels.length),
                            borderColor: borderColors.slice(0, labels.length),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true, // กราฟปรับขนาดตามหน้าจอ
                        plugins: {
                            legend: {
                                position: 'top', // ตำแหน่ง Legend
                            },
                            tooltip: { // Tooltip เมื่อเอาเมาส์ไปชี้
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += context.parsed + ' คะแนน';
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });

                // แสดงสรุปผลในรูปแบบการ์ด
                const summaryCardsContainer = document.getElementById('summary-cards');
                summaryCardsContainer.innerHTML = ''; // ล้างการ์ดเก่าออก

                // จัดเรียงแบบเสื้อตามคะแนนโหวตจากมากไปน้อย
                const sortedDesigns = [...voteCounts].sort((a, b) => b.count - a.count);

                sortedDesigns.forEach(design => {
                    const card = document.createElement('div');
                    card.className = 'summary-card';
                    card.innerHTML = `
                        <img src="${design.imageUrl || 'placeholder.png'}" alt="${design.designName}" class="card-image">
                        <p class="card-title">${design.designName}</p>
                        <p class="card-votes">คะแนน: ${design.count}</p>
                    `;
                    summaryCardsContainer.appendChild(card);
                });

            } else {
                document.getElementById('total-voters').textContent = '0';
                document.getElementById('design-charts').innerHTML = '<p style="text-align: center;">ไม่สามารถโหลดผลโหวตได้</p>';
                document.getElementById('summary-cards').innerHTML = '<p style="text-align: center;">ไม่สามารถโหลดผลโหวตได้</p>';
            }
        }

        // ฟังก์ชันสำหรับโหลดจำนวนผู้ใช้งานที่ไม่ซ้ำกัน (สำหรับแสดงผลรวมผู้โหวต)
        async function loadUniqueUsersCount() {
            const result = await callApi('getUniqueUsers');
            if (result.status === 'success') {
                // ณ ตอนนี้ 'total-voters' แสดงจำนวนผู้โหวตที่ไม่ซ้ำอยู่แล้ว
                // หากต้องการแสดงตัวเลขนี้ที่อื่น สามารถนำ result.uniqueUsersCount ไปใช้ได้เลย
            }
        }


        // ฟังก์ชันสำหรับโหลดและตรวจสอบเวลาโหวต
        async function loadVoteTime() {
            const result = await callApi('getVotingTime');
            if (result.status === 'success') {
                const startTimeStr = result.startTime;
                const endTimeStr = result.endTime;
                const now = new Date();
                let message = '';
                let isVotingOpen = true;

                if (startTimeStr && endTimeStr) {
                    try {
                        const [startHour, startMinute] = startTimeStr.split(':');
                        const [endHour, endMinute] = endTimeStr.split(':');

                        const startDate = new Date();
                        startDate.setHours(parseInt(startHour), parseInt(startMinute), 0, 0);

                        const endDate = new Date();
                        endDate.setHours(parseInt(endHour), parseInt(endMinute), 0, 0);

                        // ปรับวันที่สิ้นสุด ถ้าเวลาสิ้นสุดข้ามวัน (เช่น เปิด 22:00 ปิด 02:00)
                        if (endDate < startDate) {
                            endDate.setDate(endDate.getDate() + 1);
                        }

                        if (now < startDate) {
                            isVotingOpen = false;
                            message = `การโหวตจะเปิดเวลา ${startTimeStr} น.`;
                            submitVoteButton.disabled = true;
                            voteForm.style.display = 'none'; // ซ่อนฟอร์มโหวต
                        } else if (now > endDate) {
                            isVotingOpen = false;
                            message = `การโหวตปิดแล้ว ตั้งแต่เวลา ${endTimeStr} น.`;
                            submitVoteButton.disabled = true;
                            voteForm.style.display = 'none'; // ซ่อนฟอร์มโหวต
                        } else {
                            message = `การโหวตเปิดอยู่. ปิดเวลา ${endTimeStr} น.`;
                            submitVoteButton.disabled = false;
                            voteForm.style.display = 'block'; // แสดงฟอร์มโหวต
                        }
                    } catch (e) {
                        console.error('Error parsing voting time:', e);
                        message = 'เกิดข้อผิดพลาดในการตรวจสอบเวลาโหวต. ระบบโหวตอาจเปิดตลอดเวลา.';
                        isVotingOpen = true; // หากเกิดข้อผิดพลาด ให้ถือว่าเปิดตลอด
                        submitVoteButton.disabled = false;
                        voteForm.style.display = 'block';
                    }
                } else {
                    message = 'ไม่มีการกำหนดเวลาโหวต. ระบบโหวตเปิดอยู่.';
                    isVotingOpen = true;
                    submitVoteButton.disabled = false;
                    voteForm.style.display = 'block';
                }
                votingStatus.textContent = message; // แสดงสถานะการโหวต
                votingStatus.className = `message ${isVotingOpen ? 'info' : 'error'}`; // เปลี่ยนสีสถานะ
            } else {
                votingStatus.textContent = 'ไม่สามารถโหลดเวลาโหวตได้. ระบบโหวตอาจเปิดตลอดเวลา.';
                votingStatus.className = 'message error';
                submitVoteButton.disabled = false;
                voteForm.style.display = 'block';
            }
        }


        // --- Banner Carousel (สไลด์รูปภาพ) ---
        const bannerCarousel = document.getElementById('bannerCarousel');
        const carouselIndicators = document.getElementById('carouselIndicators');
        let currentBannerIndex = 0;
        let bannerInterval; // ตัวแปรสำหรับเก็บ Interval ของการสไลด์อัตโนมัติ

        async function loadAndDisplayBanners() {
            const result = await callApi('getBanners');
            if (result.status === 'success' && result.banners && result.banners.length > 0) {
                bannerCarousel.innerHTML = ''; // ล้างรูปภาพเก่า
                carouselIndicators.innerHTML = ''; // ล้างจุดบ่งชี้เก่า

                result.banners.forEach((url, index) => {
                    // เพิ่มรูปภาพ Banner เข้าไปใน Carousel
                    const img = document.createElement('img');
                    img.src = url;
                    img.alt = `Banner ${index + 1}`;
                    img.className = 'banner-image';
                    if (index === 0) {
                        img.classList.add('active'); // รูปแรกให้แสดงผล
                    }
                    bannerCarousel.appendChild(img);

                    // เพิ่มจุดบ่งชี้ (dots) สำหรับแต่ละรูปภาพ
                    const indicator = document.createElement('span');
                    indicator.className = 'indicator';
                    if (index === 0) {
                        indicator.classList.add('active');
                    }
                    indicator.dataset.index = index; // เก็บ index ของรูปภาพไว้ใน dataset
                    indicator.addEventListener('click', () => showBanner(index)); // เมื่อคลิกจุด ให้แสดงรูปภาพนั้น
                    carouselIndicators.appendChild(indicator);
                });

                // เริ่มสไลด์อัตโนมัติ ถ้ามี Banner มากกว่า 1 รูป
                if (result.banners.length > 1) {
                    startBannerCarousel();
                } else {
                    // ถ้ามีแค่รูปเดียว ไม่ต้องมีจุดบ่งชี้และไม่ต้องสไลด์
                    carouselIndicators.style.display = 'none';
                }

            } else {
                // กรณีไม่มี Banner
                bannerCarousel.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">ไม่พบ Banner โปรดติดต่อผู้ดูแล</p>';
                carouselIndicators.style.display = 'none';
            }
        }

        // ฟังก์ชันสำหรับแสดง Banner ที่ index ที่ระบุ
        function showBanner(index) {
            const banners = document.querySelectorAll('.banner-image');
            const indicators = document.querySelectorAll('.indicator');

            // ปรับ index หากเกินขอบเขต
            if (index >= banners.length) currentBannerIndex = 0;
            else if (index < 0) currentBannerIndex = banners.length - 1;
            else currentBannerIndex = index;

            // ซ่อนรูปภาพทั้งหมดและแสดงเฉพาะรูปที่ active
            banners.forEach((img, i) => {
                img.classList.remove('active');
                if (i === currentBannerIndex) {
                    img.classList.add('active');
                }
            });

            // อัปเดตสถานะของจุดบ่งชี้
            indicators.forEach((indicator, i) => {
                indicator.classList.remove('active');
                if (i === currentBannerIndex) {
                    indicator.classList.add('active');
                }
            });
        }

        // ฟังก์ชันสำหรับเลื่อนไป Banner ถัดไป
        function nextBanner() {
            showBanner(currentBannerIndex + 1);
        }

        // ฟังก์ชันสำหรับเริ่มการสไลด์ Banner อัตโนมัติ
        function startBannerCarousel() {
            // เคลียร์ Interval เก่าก่อนเริ่มใหม่ เพื่อป้องกันการซ้อนทับ
            if (bannerInterval) {
                clearInterval(bannerInterval);
            }
            bannerInterval = setInterval(nextBanner, 5000); // เปลี่ยนรูปทุก 5 วินาที
        }

        // เรียกโหลดข้อมูลเมื่อหน้าเว็บโหลดเสร็จ (DOMContentLoaded)
        document.addEventListener('DOMContentLoaded', () => {
            loadVoteTime(); // โหลดเวลาโหวต
            loadDesignsAndDisplay(); // โหลดแบบเสื้อและแสดงผล
            loadAndDisplayBanners(); // โหลดและแสดง Banner
        });

    </script>
</body>
</html>
