<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - ระบบโหวต</title>
    <link rel="stylesheet" href="style.css"> 
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* เพิ่มสไตล์เล็กน้อยสำหรับหน้าแอดมิน */
        .admin-container { max-width: 1200px; margin: 20px auto; padding: 20px; background: #f9f9f9; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .nav-tabs { display: flex; border-bottom: 2px solid #dee2e6; margin-bottom: 20px; }
        .nav-tab { padding: 10px 20px; cursor: pointer; background: #f1f1f1; border: 1px solid #ccc; border-bottom: none; border-radius: 5px 5px 0 0; margin-right: 5px; }
        .nav-tab.active { background: #fff; border-bottom: 2px solid #fff; position: relative; top: 1px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center; }
        .stat-card h3 { margin: 0 0 10px; font-size: 1.2em; color: #555; }
        .stat-card p { font-size: 2em; font-weight: 700; margin: 0; color: #007bff; }
        .admin-section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #f2f2f2; }
        td img.design-preview { max-width: 80px; height: auto; border-radius: 4px; }
        .danger-zone { border: 2px solid #dc3545; padding: 20px; border-radius: 8px; background: #f8d7da; }
        .danger-zone h3 { color: #721c24; }
        .button-danger { background-color: #dc3545; color: white; }
        .button-primary { background-color: #007bff; color: white; }
        .button-secondary { background-color: #6c757d; color: white; }
        button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-family: 'Kanit', sans-serif; }
    </style>
</head>
<body>
    <div class="admin-container">
        <header>
            <h1>แผงควบคุมผู้ดูแลระบบ</h1>
            <p>จัดการระบบโหวตเสื้อกีฬาสี</p>
             <a href="?page=index" target="_blank">ดูหน้าโหวตหลัก</a>
        </header>

        <div class="nav-tabs">
            <div class="nav-tab active" onclick="showTab('dashboard')">แดชบอร์ด</div>
            <div class="nav-tab" onclick="showTab('designs')">จัดการแบบเสื้อ</div>
            <div class="nav-tab" onclick="showTab('voters')">จัดการผู้โหวต</div>
            <div class="nav-tab" onclick="showTab('settings')">ตั้งค่า</div>
        </div>

        <div id="dashboard" class="tab-content active">
            <h2>ภาพรวมระบบ</h2>
            <div class="grid-container">
                <div class="stat-card">
                    <h3>โหวตทั้งหมด</h3>
                    <p id="totalVotes">...</p>
                </div>
                <div class="stat-card">
                    <h3>จำนวนแบบเสื้อ</h3>
                    <p id="totalDesigns">...</p>
                </div>
            </div>
            <div class="admin-section">
                <h3>ผลโหวตล่าสุด</h3>
                <canvas id="adminVoteChart" style="max-height: 400px;"></canvas>
            </div>
        </div>

        <div id="designs" class="tab-content">
            <div class="admin-section">
                <h2>เพิ่มแบบเสื้อใหม่</h2>
                <form id="addDesignForm">
                    <label for="designName">ชื่อ/รหัสแบบเสื้อ:</label>
                    <input type="text" id="designName" required>
                    <label for="imageUrl">URL รูปภาพ:</label>
                    <input type="url" id="imageUrl" required>
                    <button type="submit" class="button-primary">เพิ่มแบบเสื้อ</button>
                </form>
            </div>
            <div class="admin-section">
                <h2>รายการแบบเสื้อทั้งหมด</h2>
                <table id="designsTable">
                    <thead><tr><th>ID</th><th>รูปภาพ</th><th>ชื่อแบบ</th><th>คะแนน</th><th>จัดการ</th></tr></thead>
                    <tbody><tr><td colspan="5">กำลังโหลด...</td></tr></tbody>
                </table>
            </div>
        </div>

        <div id="voters" class="tab-content">
             <div class="admin-section">
                <h2>รายชื่อผู้ที่โหวตแล้ว</h2>
                <table id="votersTable">
                     <thead><tr><th>Timestamp</th><th>รหัสนักเรียน</th><th>ชื่อ-สกุล</th><th>ชั้น/ห้อง</th><th>โหวตให้</th><th>จัดการ</th></tr></thead>
                     <tbody><tr><td colspan="6">กำลังโหลด...</td></tr></tbody>
                </table>
            </div>
        </div>
        
        <div id="settings" class="tab-content">
            <div class="admin-section">
                <h2>ตั้งค่าเวลาเปิด-ปิดการโหวต</h2>
                <form id="timeSettingsForm">
                    <label for="startTime">เวลาเปิดโหวต:</label>
                    <input type="datetime-local" id="startTime">
                    <label for="endTime">เวลาปิดโหวต:</label>
                    <input type="datetime-local" id="endTime">
                    <button type="submit" class="button-primary">บันทึกเวลา</button>
                    <button type="button" class="button-secondary" onclick="clearTimes()">ล้างเวลา (เปิดตลอด)</button>
                </form>
                <p><strong>เวลาปัจจุบันของเซิร์ฟเวอร์:</strong> <span id="serverTime">...</span></p>
                <p><strong>เวลาที่ตั้งค่าไว้:</strong> เริ่ม: <span id="currentStartTime">...</span>, สิ้นสุด: <span id="currentEndTime">...</span></p>

            </div>
            <div class="danger-zone">
                <h3>Danger Zone</h3>
                <p>การกระทำในส่วนนี้ไม่สามารถย้อนกลับได้ โปรดใช้ความระมัดระวัง</p>
                <button class="button-danger" onclick="resetVotes()">ล้างผลโหวตทั้งหมด</button>
                <button class="button-danger" onclick="resetAllData()">ล้างข้อมูลทั้งระบบ</button>
            </div>
        </div>
    </div>

    <script>
        const WEB_APP_URL = '<?= ScriptApp.getService().getUrl() ?>';
        let adminVoteChartInstance = null;
        
        // --- API Caller ---
        async function callApi(action, data = {}) {
            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action, ...data }),
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                if(result.status === 'error') throw new Error(result.message);
                return result;
            } catch (error) {
                console.error('API Error:', error);
                Swal.fire('เกิดข้อผิดพลาด', error.message, 'error');
                return null;
            }
        }

        // --- Tab Management ---
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`.nav-tab[onclick="showTab('${tabName}')"]`).classList.add('active');
            
            // Load data for the active tab
            if (tabName === 'dashboard') loadDashboardData();
            if (tabName === 'designs') loadDesigns();
            if (tabName === 'voters') loadVoters();
            if (tabName === 'settings') loadTimeSettings();
        }

        // --- Data Loading Functions ---
        async function loadDashboardData() {
            const data = await callApi('getAdminDashboardData');
            if (!data) return;

            document.getElementById('totalVotes').textContent = data.totalVotes;
            document.getElementById('totalDesigns').textContent = data.totalDesigns;
            
            const ctx = document.getElementById('adminVoteChart').getContext('2d');
            const labels = data.voteResults.map(v => `${v.designId} (${v.designName})`);
            const votes = data.voteResults.map(v => v.voteCount);

            if(adminVoteChartInstance) adminVoteChartInstance.destroy();
            adminVoteChartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ label: 'คะแนนโหวต', data: votes, backgroundColor: 'rgba(0, 123, 255, 0.7)' }] },
                options: { responsive: true }
            });
        }
        
        async function loadDesigns() {
            const data = await callApi('getDesigns');
            const tableBody = document.querySelector('#designsTable tbody');
            if (!data || !data.designs) {
                tableBody.innerHTML = '<tr><td colspan="5">ไม่สามารถโหลดข้อมูลได้</td></tr>';
                return;
            }
            
            tableBody.innerHTML = '';
            if (data.designs.length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="5">ยังไม่มีแบบเสื้อในระบบ</td></tr>';
            } else {
                data.designs.forEach(d => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${d.designId}</td>
                        <td><img src="${d.imageUrl}" alt="${d.designName}" class="design-preview"></td>
                        <td>${d.designName}</td>
                        <td>${d.voteCount}</td>
                        <td><button class="button-danger" onclick="deleteDesign('${d.designId}')">ลบ</button></td>
                    `;
                });
            }
        }
        
        async function loadVoters() {
            const data = await callApi('getVoters');
            const tableBody = document.querySelector('#votersTable tbody');
            if (!data || !data.voters) {
                 tableBody.innerHTML = '<tr><td colspan="6">ไม่สามารถโหลดข้อมูลได้</td></tr>';
                return;
            }
            tableBody.innerHTML = '';
            if (data.voters.length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="6">ยังไม่มีผู้โหวต</td></tr>';
            } else {
                 data.voters.forEach(v => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${new Date(v.timestamp).toLocaleString()}</td>
                        <td>${v.studentId}</td>
                        <td>${v.fullName}</td>
                        <td>${v.grade}/${v.room}</td>
                        <td>${v.voteChoice}</td>
                        <td><button class="button-danger" onclick="deleteVoter('${v.studentId}')">ลบ</button></td>
                    `;
                });
            }
        }
        
        async function loadTimeSettings() {
            const data = await callApi('getVoteTime');
            if(!data) return;

            document.getElementById('serverTime').textContent = new Date(data.serverNow).toLocaleString();
            document.getElementById('currentStartTime').textContent = data.startTime ? new Date(data.startTime).toLocaleString() : 'ไม่ได้ตั้งค่า';
            document.getElementById('currentEndTime').textContent = data.endTime ? new Date(data.endTime).toLocaleString() : 'ไม่ได้ตั้งค่า';
            if (data.startTime) document.getElementById('startTime').value = data.startTime.slice(0, 16);
            if (data.endTime) document.getElementById('endTime').value = data.endTime.slice(0, 16);
        }

        // --- Action Functions ---
        document.getElementById('addDesignForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const designName = document.getElementById('designName').value;
            const imageUrl = document.getElementById('imageUrl').value;
            
            const result = await callApi('addDesign', { designName, imageUrl });
            if (result && result.status === 'success') {
                Swal.fire('สำเร็จ', 'เพิ่มแบบเสื้อเรียบร้อย', 'success');
                document.getElementById('addDesignForm').reset();
                loadDesigns();
                loadDashboardData();
            }
        });
        
        async function deleteDesign(designId) {
            const confirmation = await Swal.fire({
                title: 'ยืนยันการลบ?',
                text: `คุณต้องการลบแบบเสื้อ ID: ${designId} ใช่หรือไม่?`,
                icon: 'warning', showCancelButton: true, confirmButtonText: 'ใช่, ลบเลย!', cancelButtonText: 'ยกเลิก'
            });
            if(confirmation.isConfirmed) {
                 const result = await callApi('deleteDesign', { designId });
                 if(result && result.status === 'success') {
                     Swal.fire('สำเร็จ', 'ลบแบบเสื้อแล้ว', 'success');
                     loadDesigns();
                     loadDashboardData();
                 }
            }
        }
        
        async function deleteVoter(studentId) {
            const confirmation = await Swal.fire({
                title: 'ยืนยันการลบ?',
                text: `คุณต้องการลบข้อมูลการโหวตของรหัสนักเรียน ${studentId} ใช่หรือไม่?`,
                icon: 'warning', showCancelButton: true, confirmButtonText: 'ใช่, ลบเลย!', cancelButtonText: 'ยกเลิก'
            });
             if(confirmation.isConfirmed) {
                 const result = await callApi('deleteVoter', { studentId });
                 if(result && result.status === 'success') {
                     Swal.fire('สำเร็จ', 'ลบข้อมูลผู้โหวตแล้ว', 'success');
                     loadVoters();
                     loadDashboardData();
                 }
            }
        }
        
        document.getElementById('timeSettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            
            if (!startTime || !endTime) {
                Swal.fire('ข้อมูลไม่ครบ', 'กรุณาเลือกทั้งเวลาเปิดและปิด', 'warning');
                return;
            }
            
            const result = await callApi('setVoteTime', { startTime, endTime });
            if (result && result.status === 'success') {
                Swal.fire('สำเร็จ', 'ตั้งค่าเวลาเรียบร้อย', 'success');
                loadTimeSettings();
            }
        });
        
        async function clearTimes() {
            const result = await callApi('clearVoteTime');
            if (result && result.status === 'success') {
                Swal.fire('สำเร็จ', 'ล้างการตั้งค่าเวลาแล้ว (เปิดโหวตตลอด)', 'success');
                document.getElementById('timeSettingsForm').reset();
                loadTimeSettings();
            }
        }

        async function resetVotes() {
             const confirmation = await Swal.fire({
                title: 'แน่ใจหรือว่าต้องการล้างผลโหวต?',
                text: "การกระทำนี้จะลบรายชื่อผู้โหวตและรีเซ็ตคะแนนทั้งหมด แต่แบบเสื้อจะยังอยู่",
                icon: 'warning', showCancelButton: true, confirmButtonText: 'ใช่, ล้างผลโหวต!', cancelButtonText: 'ยกเลิก', confirmButtonColor: '#d33'
            });
             if(confirmation.isConfirmed) {
                const result = await callApi('resetVotes');
                if (result && result.status === 'success') {
                    Swal.fire('สำเร็จ!', 'ล้างผลโหวตเรียบร้อยแล้ว', 'success');
                    showTab('dashboard');
                }
             }
        }
        
        async function resetAllData() {
            const { value: confirmationText } = await Swal.fire({
                title: 'คำเตือนรุนแรง!',
                text: "คุณกำลังจะลบข้อมูลทั้งหมดในระบบ (แบบเสื้อ, ผู้โหวต, คะแนน) การกระทำนี้ไม่สามารถย้อนกลับได้! หากต้องการดำเนินการต่อ พิมพ์ 'CONFIRM' ในช่องด้านล่าง",
                input: 'text',
                inputPlaceholder: 'พิมพ์ CONFIRM ที่นี่',
                icon: 'error',
                showCancelButton: true,
                confirmButtonText: 'ล้างข้อมูลทั้งหมด',
                cancelButtonText: 'ยกเลิก',
                confirmButtonColor: '#d33',
                inputValidator: (value) => {
                    if (value !== 'CONFIRM') {
                        return 'คุณต้องพิมพ์ CONFIRM ให้ถูกต้อง!'
                    }
                }
            });
             if(confirmationText) {
                const result = await callApi('resetAllData');
                if (result && result.status === 'success') {
                    Swal.fire('สำเร็จ!', 'ข้อมูลทั้งระบบถูกลบเรียบร้อยแล้ว', 'success');
                    showTab('dashboard');
                }
             }
        }
        
        // Initial load
        window.onload = () => showTab('dashboard');
    </script>
</body>
</html>
