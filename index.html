<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>โหวตแบบเสื้อกีฬาสี | โรงเรียนภูหลวงวิทยา</title>
<link href="https://fonts.googleapis.com/css2?family=Kanit&display=swap" rel="stylesheet" />
<style>
  body {
    font-family: 'Kanit', sans-serif;
    background: linear-gradient(135deg, #FFDEE9 0%, #B5FFFC 100%);
    margin: 0; padding: 0;
  }
  header {
    background-color: #f25c54;
    color: white;
    text-align: center;
    padding: 1.5rem;
    font-weight: 600;
    font-size: 1.8rem;
  }
  .container {
    max-width: 900px;
    margin: 2rem auto;
    padding: 0 1rem;
  }
  .timer {
    background: #fff;
    border-radius: 10px;
    padding: 1rem;
    text-align: center;
    font-weight: 700;
    font-size: 1.2rem;
    color: #f25c54;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 10px rgba(242,92,84,0.4);
  }
  .cards {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(240px,1fr));
    gap: 1rem;
  }
  .card {
    background: white;
    border-radius: 15px;
    box-shadow: 0 6px 12px rgba(0,0,0,0.1);
    overflow: hidden;
    transition: transform 0.3s ease;
  }
  .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.15);
  }
  .card img {
    width: 100%;
    height: 180px;
    object-fit: contain;
    background: #f9f9f9;
  }
  .card-body {
    padding: 1rem;
    text-align: center;
  }
  .card-body h3 {
    margin: 0.5rem 0 1rem 0;
    font-weight: 600;
  }
  .vote-button {
    background-color: #f25c54;
    border: none;
    color: white;
    padding: 0.75rem 1.2rem;
    font-size: 1rem;
    border-radius: 50px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    width: 100%;
  }
  .vote-button:hover {
    background-color: #d84b45;
  }
  .form-section {
    margin: 2rem 0;
    background: white;
    padding: 1rem 1.5rem;
    border-radius: 10px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.1);
  }
  .form-section label {
    display: block;
    margin-bottom: 0.3rem;
    font-weight: 500;
  }
  .form-section input {
    width: 100%;
    padding: 0.5rem 0.75rem;
    margin-bottom: 1rem;
    border-radius: 6px;
    border: 1px solid #ddd;
    font-size: 1rem;
  }
  .form-section .submit-button {
    background-color: #f25c54;
    color: white;
    border: none;
    padding: 0.85rem 1.5rem;
    border-radius: 30px;
    font-size: 1.1rem;
    cursor: pointer;
    width: 100%;
  }
  .form-section .submit-button:hover {
    background-color: #d84b45;
  }
  .toast {
    position: fixed;
    bottom: 20px; left: 50%;
    transform: translateX(-50%);
    background: #f25c54;
    color: white;
    padding: 1rem 2rem;
    border-radius: 30px;
    font-weight: 600;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    z-index: 1000;
  }
  .toast.show {
    opacity: 1;
    pointer-events: auto;
  }
</style>
</head>
<body>
<header>โหวตแบบเสื้อกีฬาสี โรงเรียนภูหลวงวิทยา</header>
<div class="container">

  <div class="timer" id="voteTimer">กำลังโหลดเวลาโหวต...</div>

  <form id="voteForm" class="form-section">
    <label for="studentId">รหัสนักเรียน</label>
    <input type="text" id="studentId" name="studentId" placeholder="กรอกรหัสนักเรียนของคุณ" required />

    <label for="fullName">ชื่อ-นามสกุล</label>
    <input type="text" id="fullName" name="fullName" placeholder="กรอกชื่อ-นามสกุล" required />

    <label for="grade">ระดับชั้น</label>
    <input type="text" id="grade" name="grade" placeholder="เช่น ม.1, ม.2 ..." required />

    <label for="room">ห้องเรียน</label>
    <input type="text" id="room" name="room" placeholder="เช่น 1, 2, 3 ..." required />
  </form>

  <div class="cards" id="designCards">
    <!-- แบบเสื้อจะแสดงที่นี่ด้วย JS -->
  </div>

  <button type="submit" form="voteForm" class="submit-button" id="submitVoteBtn" disabled>เลือกแบบเสื้อก่อนโหวต</button>

</div>

<div class="toast" id="toastMsg">ข้อความแจ้งเตือน</div>

<script>
  const WEB_APP_URL = 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL';

  let selectedDesignId = null;

  const voteTimerEl = document.getElementById('voteTimer');
  const designCardsEl = document.getElementById('designCards');
  const submitVoteBtn = document.getElementById('submitVoteBtn');
  const toast = document.getElementById('toastMsg');

  // ฟังก์ชันแสดงข้อความ Toast
  function showToast(message) {
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 3000);
  }

  // โหลดข้อมูลแบบเสื้อจาก API
  async function loadDesigns() {
    try {
      const res = await fetch(WEB_APP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ action: 'getDesigns' }),
      });
      const data = await res.json();
      if (data.status === 'success') {
        renderDesignCards(data.designs);
      } else {
        voteTimerEl.textContent = 'ไม่สามารถโหลดแบบเสื้อได้';
      }
    } catch {
      voteTimerEl.textContent = 'เกิดข้อผิดพลาดในการโหลดข้อมูล';
    }
  }

  // แสดงแบบเสื้อในรูปแบบการ์ด
  function renderDesignCards(designs) {
    designCardsEl.innerHTML = '';
    designs.forEach(d => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <img src="${d.imageUrl || 'https://via.placeholder.com/300x180?text=No+Image'}" alt="แบบเสื้อ ${d.designName}">
        <div class="card-body">
          <h3>${d.designId} - ${d.designName}</h3>
          <button class="vote-button" data-id="${d.designId}">โหวตแบบนี้</button>
        </div>
      `;
      designCardsEl.appendChild(card);
    });

    // เพิ่ม Event listener ให้ปุ่มโหวตแต่ละใบ
    document.querySelectorAll('.vote-button').forEach(btn => {
      btn.addEventListener('click', () => {
        selectedDesignId = btn.getAttribute('data-id');
        submitVoteBtn.disabled = false;
        showToast(`เลือกแบบเสื้อ ${selectedDesignId} เรียบร้อยแล้ว`);
      });
    });
  }

  // โหลดเวลาโหวต
  async function loadVoteTime() {
    try {
      const res = await fetch(WEB_APP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ action: 'getVoteTime' }),
      });
      const data = await res.json();
      if (data.status === 'success' && data.startTime && data.endTime) {
        const now = new Date();
        const start = new Date(data.startTime);
        const end = new Date(data.endTime);
        if (now < start) {
          voteTimerEl.textContent = `โหวตจะเริ่มในวันที่ ${start.toLocaleString('th-TH')}`;
          submitVoteBtn.disabled = true;
        } else if (now > end) {
          voteTimerEl.textContent = 'โหวตปิดแล้ว ขอบคุณที่ร่วมโหวตครับ!';
          submitVoteBtn.disabled = true;
        } else {
          voteTimerEl.textContent = `โหวตเปิดอยู่จนถึงวันที่ ${end.toLocaleString('th-TH')}`;
          submitVoteBtn.disabled = false;
        }
      } else {
        voteTimerEl.textContent = 'ยังไม่มีการตั้งเวลาโหวต';
        submitVoteBtn.disabled = true;
      }
    } catch {
      voteTimerEl.textContent = 'ไม่สามารถโหลดข้อมูลเวลาโหวตได้';
      submitVoteBtn.disabled = true;
    }
  }

  // ส่งโหวต
  document.getElementById('voteForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!selectedDesignId) {
      showToast('กรุณาเลือกแบบเสื้อก่อนโหวต');
      return;
    }

    const formData = {
      action: 'submitVote',
      studentId: document.getElementById('studentId').value.trim(),
      fullName: document.getElementById('fullName').value.trim(),
      grade: document.getElementById('grade').value.trim(),
      room: document.getElementById('room').value.trim(),
      voteChoice: selectedDesignId,
    };

    // ตรวจสอบข้อมูลพื้นฐาน
    if (!formData.studentId || !formData.fullName || !formData.grade || !formData.room) {
      showToast('กรุณากรอกข้อมูลให้ครบถ้วน');
      return;
    }

    submitVoteBtn.disabled = true;
    submitVoteBtn.textContent = 'กำลังส่งโหวต...';

    try {
      const res = await fetch(WEB_APP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(formData),
      });
      const data = await res.json();
      if (data.status === 'success') {
        showToast('โหวตสำเร็จ ขอบคุณที่ร่วมโหวตครับ!');
        // ล้างข้อมูลและปิดการเลือก
        selectedDesignId = null;
        submitVoteBtn.disabled = true;
        submitVoteBtn.textContent = 'เลือกแบบเสื้อก่อนโหวต';
        document.getElementById('voteForm').reset();
      } else {
        showToast(data.message || 'เกิดข้อผิดพลาดในการโหวต');
      }
    } catch {
      showToast('ไม่สามารถส่งโหวตได้ กรุณาลองใหม่ภายหลัง');
    } finally {
      submitVoteBtn.disabled = false;
      submitVoteBtn.textContent = 'ส่งโหวต';
    }
  });

  // โหลดข้อมูลเริ่มต้น
  loadVoteTime();
  loadDesigns();

</script>
</body>
</html>
